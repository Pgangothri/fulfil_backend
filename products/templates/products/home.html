<!DOCTYPE html>
<html lang="en">
<head>
    <title>Product Importer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root {
            --main-bg: #f5f6fa;
            --primary: #3265fa;
            --danger: #ff4444;
            --success: #4CAF50;
            --shadow: 0 2px 8px rgba(44,44,44,0.10);
        }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: var(--main-bg);
            color: #222;
            margin: 0;
            padding: 0;
        }
        h1 { font-size: 2rem; margin-top: 32px; margin-bottom: 20px; text-align: center; color: var(--primary); }
        .tab {
            display: flex;
            background: #fff;
            border-radius: 8px;
            box-shadow: var(--shadow);
            justify-content: center;
            margin: 20px 40px 0 40px;
            overflow-x: auto;
        }
        .tab button {
            padding: 15px 32px;
            font-size: 1rem;
            border: none;
            background: none;
            color: var(--primary);
            transition: background 0.2s, color 0.2s;
            cursor: pointer;
        }
        .tab button.active, .tab button:focus {
            background-color: var(--primary);
            color: #fff;
            outline: none;
        }
        .tab button:hover:not(.active) {
            background: #eee;
        }
        .tabcontent {
            display: none;
            background: #fff;
            margin: 0 40px 32px 40px;
            padding: 32px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            min-height: 100px;
        }
        .progress-bar {
            width: 100%;
            background: #e6e6e6;
            border-radius: 8px;
        }
        .progress {
            height: 18px;
            background: var(--success);
            border-radius: 8px;
            width: 0%;
            transition: width 0.2s;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 24px;
            font-size: 1rem;
        }
        th, td {
            padding: 12px 10px;
            border: 1px solid #e6e6e6;
        }
        th {
            background: var(--main-bg);
            font-weight: 500;
            color: var(--primary);
        }
        tr:nth-child(even) {
            background: #fafcff;
        }
        button, input, select, textarea {
            font-size: 1rem;
            border-radius: 6px;
            border: 1px solid #ccc;
            padding: 10px 12px;
            margin-right: 5px;
        }
        .btn {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 8px 18px;
            margin: 4px 0;
            cursor: pointer;
            transition: background 0.18s;
        }
        .btn.danger { background: var(--danger); }
        .btn.success { background: var(--success); }
        .btn:hover { filter: brightness(1.1); }
        .btn:active { filter: brightness(0.95); }
        input[type="text"], input[type="url"], textarea, select {
            background: #fafbff;
            border: 1px solid #ccc;
            padding: 8px 10px;
            min-width: 150px;
            margin-bottom: 8px;
        }
        .pagination button {
            padding: 7px 14px;
            border: none;
            background: #eee;
            color: var(--primary);
            margin-right: 4px;
            border-radius: 3px;
        }
        .pagination button.active {
            background: var(--primary);
            color: #fff;
            font-weight: bold;
        }
        .pagination button:hover:not(.active) {
            background: #ddd;
        }
        .pagination span {
            margin: 0 4px;
            color: #888;
        }
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(22,43,80,0.22);
            z-index: 999;
            display: none;
        }
        #productModal, #webhookModalBox {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border-radius: 10px;
            box-shadow: var(--shadow);
            z-index: 1000;
            min-width: 320px;
            max-width: 410px;
            padding: 32px 18px 18px 18px;
        }
        #productModal label, #webhookModalBox label {
            display: block;
            margin-bottom: 4px;
        }
        #productModal input, #productModal textarea,
        #webhookModalBox input, #webhookModalBox textarea {
            width: 92%;
            margin-bottom: 13px;
        }
        #productModal button, #webhookModalBox button {
            margin-right: 10px;
        }
        @media (max-width: 670px) {
            body { margin: 6px;}
            .tab, .tabcontent { margin: 10px; padding: 12px;}
        }
    </style>
</head>
<body>
    <h1>Product Importer</h1>
    <div class="tab">
        <button class="tablinks" onclick="openTab(event, 'Upload')">Upload CSV</button>
        <button class="tablinks" onclick="openTab(event, 'Products')">Manage Products</button>
        <button class="tablinks" onclick="openTab(event, 'Webhooks')">Webhooks</button>
    </div>
    
    <div id="Upload" class="tabcontent">
      <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:300px;">
        <h2 style="margin-bottom:18px;">Upload Products CSV</h2>
        <input type="file" id="csvFile" accept=".csv" style="margin-bottom:12px;">
        <button class="btn success" onclick="uploadFile()" style="min-width:120px;">Upload</button>
        <div id="uploadProgress" style="display: none; width:340px; margin-top:30px;">
          <h3>Upload Progress</h3>
          <div class="progress-bar"><div id="progress" class="progress"></div></div>
          <div id="progressText">0%</div>
          <div id="statusMessage"></div>
        </div>
      </div>
    </div>
    
   <div id="Products" class="tabcontent">
    <h2>Product Management</h2>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
        <div>
            <input type="text" id="searchSku" placeholder="Filter by SKU">
            <input type="text" id="searchName" placeholder="Filter by Name">
            <select id="searchActive">
                <option value="">All Status</option>
                <option value="true">Active</option>
                <option value="false">Inactive</option>
            </select>
            <button class="btn" onclick="loadProducts()">Filter</button>
            <button class="btn success" onclick="showCreateForm()">Create Product</button>
        </div>
        <div>
            <button class="btn danger" onclick="bulkDelete()">Delete All Products</button>
        </div>
    </div>
    <div id="productsTable"></div>
    <div id="pagination"></div>
</div>

    
    <div id="Webhooks" class="tabcontent">
        <h2>Webhook Configuration</h2>
        <div>
            <h3>Add Webhook</h3>
            <input type="url" id="webhookUrl" placeholder="Webhook URL" style="width: 85%;">
            <select id="webhookEvent">
                <option value="product.created">Product Created</option>
                <option value="product.updated">Product Updated</option>
                <option value="product.deleted">Product Deleted</option>
                <option value="import.completed">Import Completed</option>
            </select>
            <button class="btn success" onclick="addWebhook()">Add Webhook</button>
        </div>
        <div id="webhooksList" style="margin-top: 24px;"></div>
    </div>
    
    <div id="modalOverlay" class="modal-overlay"></div>
    
    <div id="productModal">
        <h3 id="modalTitle">Create Product</h3>
        <form id="productForm" autocomplete="off" onsubmit="return false;">
            <input type="hidden" id="productId">
            <div>
                <label for="sku">SKU:</label>
                <input type="text" id="sku" required>
            </div>
            <div>
                <label for="name">Name:</label>
                <input type="text" id="name" required>
            </div>
            <div>
                <label for="description">Description:</label>
                <textarea id="description" rows="2"></textarea>
            </div>
            <div>
                <label for="active">Active:</label>
                <input type="checkbox" id="active" checked>
            </div>
            <button class="btn success" type="button" onclick="saveProduct()">Save</button>
            <button class="btn danger" type="button" onclick="closeModal()">Cancel</button>
        </form>
    </div>
    
    <div id="webhookModalBox">
      <h3>Edit Webhook</h3>
      <input type="hidden" id="editWebhookId">
      <label>URL:</label>
      <input type="url" id="editWebhookUrl" required><br>
      <label>Event Type:</label>
      <select id="editWebhookEvent">
        <option value="product.created">Product Created</option>
        <option value="product.updated">Product Updated</option>
        <option value="product.deleted">Product Deleted</option>
        <option value="import.completed">Import Completed</option>
      </select><br>
      <label>Status:</label>
      <select id="editWebhookStatus">
        <option value="true">Active</option>
        <option value="false">Inactive</option>
      </select><br><br>
      <button class="btn success" onclick="saveWebhookEdit()">Save</button>
      <button class="btn danger" onclick="closeWebhookModal()">Cancel</button>
    </div>
    
    <script>
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
            if (tabName === 'Products') loadProducts();
            if (tabName === 'Webhooks') loadWebhooks();
        }
        
        function showModalOverlay(show) {
            document.getElementById('modalOverlay').style.display = show ? 'block' : 'none';
            if (show) document.body.style.overflow = 'hidden';
            else document.body.style.overflow = '';
        }
        function showCreateForm() {
            document.getElementById('modalTitle').textContent = 'Create Product';
            document.getElementById('productId').value = '';
            document.getElementById('sku').value = '';
            document.getElementById('name').value = '';
            document.getElementById('description').value = '';
            document.getElementById('active').checked = true;
            showModalOverlay(true);
            document.getElementById('productModal').style.display = 'block';
        }
        function closeModal() {
            document.getElementById('productModal').style.display = 'none';
            showModalOverlay(false);
        }
        let currentPage = 1;
        async function uploadFile() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            if (!file) { alert('Please select a CSV file'); return; }
            const formData = new FormData();
            formData.append('file', file);
            try {
                const response = await fetch('/api/upload/', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (response.ok) {
                    document.getElementById('uploadProgress').style.display = 'block';
                    trackProgress(data.task_id);
                } else alert('Upload failed: ' + data.error);
            } catch (error) { alert('Upload failed: ' + error.message); }
        }
        async function trackProgress(taskId) {
            const progressBar = document.getElementById('progress');
            const progressText = document.getElementById('progressText');
            const statusMessage = document.getElementById('statusMessage');
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/tasks/${taskId}/`);
                    const data = await response.json();
                    if (data.status === 'PROGRESS') {
                        const percent = Math.round((data.current / data.total) * 100);
                        progressBar.style.width = percent + '%';
                        progressText.textContent = `${percent}% (${data.current}/${data.total})`;
                        statusMessage.textContent = data.status;
                    } else if (data.status === 'SUCCESS') {
                        progressBar.style.width = '100%';
                        progressText.textContent = '100% - Completed';
                        statusMessage.textContent = `Import completed: ${data.processed} products processed`;
                        clearInterval(interval); loadProducts();
                    } else if (data.status === 'FAILURE') {
                        statusMessage.textContent = 'Import failed: ' + data.error;
                        clearInterval(interval);
                    }
                } catch (error) { console.error('Error tracking progress:', error); clearInterval(interval); }
            }, 1000);
        }
        async function loadProducts(page = 1) {
            currentPage = page;
            const sku = document.getElementById('searchSku').value;
            const name = document.getElementById('searchName').value;
            const active = document.getElementById('searchActive').value;
            const params = new URLSearchParams();
            if (sku) params.append('sku', sku);
            if (name) params.append('name', name);
            if (active) params.append('active', active);
            params.append('page', page);
            try {
                const response = await fetch(`/api/products/?${params}`);
                const data = await response.json();
                let tableHtml = `
                    <table>
                        <tr>
                            <th>SKU</th>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Status</th>
                            <th>Edit</th>
                            <th>Delete</th>
                        </tr>
                `;
                data.products.forEach(product => {
                    tableHtml += `
                        <tr>
                            <td>${product.sku}</td>
                            <td>${product.name}</td>
                            <td>${product.description || ''}</td>
                            <td style="color:${product.active ? 'var(--success)' : 'var(--danger)'};font-weight:500">
                                ${product.active ? 'Active' : 'Inactive'}
                            </td>
                            <td>
                                <button class="btn" onclick="editProduct(${product.id})">Edit</button>
                            </td>
                            <td>
                                <button class="btn danger" onclick="deleteProduct(${product.id})">Delete</button>
                            </td>
                        </tr>
                    `;
                });
                tableHtml += '</table>';
                document.getElementById('productsTable').innerHTML = tableHtml;
                // Pagination (limited)
                let paginationHtml = '';
                if (data.total_pages > 1) {
                    paginationHtml = '<div class="pagination">';
                    const total = data.total_pages, page = currentPage;
                    if (page > 3) {
                        paginationHtml += `<button onclick="loadProducts(1)">1</button>`;
                        if (page > 4) paginationHtml += `<span>...</span>`;
                    }
                    for (let i = Math.max(1, page-2); i <= Math.min(total, page+2); i++) {
                        if (i === page)
                            paginationHtml += `<button class="active">${i}</button>`;
                        else
                            paginationHtml += `<button onclick="loadProducts(${i})">${i}</button>`;
                    }
                    if (page < total - 2) {
                        if (page < total - 3) paginationHtml += `<span>...</span>`;
                        paginationHtml += `<button onclick="loadProducts(${total})">${total}</button>`;
                    }
                    if (page > 1)
                        paginationHtml = `<button onclick="loadProducts(${page - 1})">Prev</button>` + paginationHtml;
                    if (page < total)
                        paginationHtml += `<button onclick="loadProducts(${page + 1})">Next</button>`;
                    paginationHtml += '</div>';
                }
                document.getElementById('pagination').innerHTML = paginationHtml;
            } catch (error) { console.error('Error loading products:', error); }
        }
        async function editProduct(productId) {
            try {
                const response = await fetch(`/api/products/${productId}/`);
                const product = await response.json();
                document.getElementById('modalTitle').textContent = 'Edit Product';
                document.getElementById('productId').value = product.id;
                document.getElementById('sku').value = product.sku;
                document.getElementById('name').value = product.name;
                document.getElementById('description').value = product.description || '';
                document.getElementById('active').checked = product.active;
                showModalOverlay(true);
                document.getElementById('productModal').style.display = 'block';
            } catch (error) { console.error('Error loading product:', error); }
        }
        async function saveProduct() {
            const productId = document.getElementById('productId').value;
            const url = productId ? `/api/products/${productId}/` : '/api/products/create/';
            const productData = {
                sku: document.getElementById('sku').value,
                name: document.getElementById('name').value,
                description: document.getElementById('description').value,
                active: document.getElementById('active').checked
            };
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });
                if (response.ok) {
                    closeModal();
                    loadProducts(currentPage);
                } else {
                    const error = await response.json();
                    alert('Error saving product: ' + error.error);
                }
            } catch (error) { alert('Error saving product: ' + error.message); }
        }
        async function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    const response = await fetch(`/api/products/${productId}/`, {
                        method: 'DELETE'
                    });
                    if (response.ok) loadProducts(currentPage);
                    else alert('Error deleting product');
                } catch (error) { alert('Error deleting product: ' + error.message); }
            }
        }
        async function bulkDelete() {
            if (confirm('Are you sure you want to delete ALL products? This cannot be undone.')) {
                try {
                    const response = await fetch('/api/bulk-delete/', { method: 'POST' });
                    const data = await response.json();
                    if (response.ok) {
                        alert('Bulk deletion started');
                        loadProducts();
                    } else { alert('Bulk deletion failed: ' + data.error); }
                } catch (error) { alert('Bulk deletion failed: ' + error.message); }
            }
        }
        async function loadWebhooks() {
            try {
                const response = await fetch('/api/webhooks/');
                const data = await response.json();
                let html = '<h3>Configured Webhooks</h3><table><tr><th>URL</th><th>Event Type</th><th>Status</th><th>Actions</th></tr>';
                data.webhooks.forEach(webhook => {
                    html += `
                        <tr>
                          <td style="max-width:290px;word-break:break-all;">${webhook.url}</td>
                          <td>${webhook.event_type}</td>
                          <td style="color:${webhook.is_active?'var(--success)':'var(--danger)'};">
                            ${webhook.is_active ? 'Active' : 'Inactive'}
                          </td>
                          <td>
                            <button class="btn" onclick="showEditWebhook(${webhook.id})">Edit</button>
                            <button class="btn" onclick="toggleWebhook(${webhook.id}, ${!webhook.is_active})">
                              ${webhook.is_active ? 'Disable' : 'Enable'}
                            </button>
                            <button class="btn" onclick="testWebhook(${webhook.id})">Test</button>
                            <button class="btn danger" onclick="deleteWebhook(${webhook.id})">Delete</button>
                          </td>
                        </tr>
                    `;
                });
                html += '</table>';
                document.getElementById('webhooksList').innerHTML = html;
            } catch (error) { console.error('Error loading webhooks:', error); }
        }

        async function addWebhook() {
            const url = document.getElementById('webhookUrl').value;
            const eventType = document.getElementById('webhookEvent').value;
            if (!url) { alert('Please enter a webhook URL'); return; }
            try {
                const response = await fetch('/api/webhooks/create/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url, event_type: eventType, is_active: true })
                });
                if (response.ok) {
                    document.getElementById('webhookUrl').value = '';
                    loadWebhooks();
                } else {
                    const error = await response.json();
                    alert('Error adding webhook: ' + error.error);
                }
            } catch (error) { alert('Error adding webhook: ' + error.message); }
        }
        function showEditWebhook(id) {
          fetch('/api/webhooks/')
            .then(res => res.json())
            .then(data => {
              const w = data.webhooks.find(wb => wb.id === id);
              document.getElementById('editWebhookId').value = w.id;
              document.getElementById('editWebhookUrl').value = w.url;
              document.getElementById('editWebhookEvent').value = w.event_type;
              document.getElementById('editWebhookStatus').value = w.is_active ? "true" : "false";
              document.getElementById('webhookModalBox').style.display = 'block';
              showModalOverlay(true);
            });
        }
        function closeWebhookModal() {
          document.getElementById('webhookModalBox').style.display = 'none';
          showModalOverlay(false);
        }
        async function saveWebhookEdit() {
          const id = document.getElementById('editWebhookId').value;
          const url = document.getElementById('editWebhookUrl').value;
          const eventType = document.getElementById('editWebhookEvent').value;
          const isActive = document.getElementById('editWebhookStatus').value === "true";
          const response = await fetch(`/api/webhooks/${id}/`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: url, event_type: eventType, is_active: isActive })
          });
          if (response.ok) {
            closeWebhookModal();
            loadWebhooks();
          } else {
            alert('Error updating webhook');
          }
        }
        async function toggleWebhook(id, setActive) {
            const response = await fetch(`/api/webhooks/${id}/`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_active: setActive })
            });
            if (response.ok) loadWebhooks();
            else alert('Error toggling webhook');
        }
        async function testWebhook(webhookId) {
            try {
                const response = await fetch(`/api/webhooks/${webhookId}/test/`, { method: 'POST' });
                if (response.ok) alert('Test webhook triggered');
                else alert('Error triggering webhook');
            } catch (error) { alert('Error triggering webhook: ' + error.message); }
        }
        async function deleteWebhook(webhookId) {
            if (confirm('Are you sure you want to delete this webhook?')) {
                try {
                    const response = await fetch(`/api/webhooks/${webhookId}/`, { method: 'DELETE' });
                    if (response.ok) loadWebhooks();
                    else alert('Error deleting webhook');
                } catch (error) { alert('Error deleting webhook: ' + error.message); }
            }
        }
        document.getElementById('modalOverlay').onclick = function() {
          closeModal();
          closeWebhookModal();
        };
        window.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
              closeModal();
              closeWebhookModal();
            }
        });
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementsByClassName('tablinks')[0].click();
        });
    </script>
</body>
</html>
